import{r as o,j as e,g as X,a6 as O,h as Y}from"./index-CJ-wuhK9.js";import{F as U,i as ee}from"./index-i2QTIEgf.js";import{b as M,c as $,d as L,e as R,f as A}from"./DefaultLayout-B-qmEVbh.js";import{C as te}from"./CForm-UkVSUVnU.js";import{C as w,a as g}from"./CRow-Cad186SE.js";import{C as D}from"./CFormInput-CBBV5oX5.js";import{C as se}from"./CFormTextarea-Q98ELNPm.js";import{C as W}from"./CFormCheck-C7IAmBl7.js";import{a as p}from"./index.esm-Cc_xDpa3.js";import{C as ae}from"./CListGroup-9FGUvHJq.js";import{C as re}from"./CListGroupItem-D7CgEIQF.js";import"./cil-lock-locked-wpvjoNjh.js";import"./cil-user-Ddrdy7PS.js";import"./CFormControlWrapper-Ctc-jqYh.js";const oe=({visible:u,onClose:j,onCreateEvent:c,projectCalendars:C})=>{const[n,f]=o.useState({summary:"",description:"",start:"",end:"",selectedCalendars:{}}),d=s=>{const{name:a,value:r}=s.target;f(v=>({...v,[a]:r}))},y=s=>{f(a=>({...a,selectedCalendars:{...a.selectedCalendars,[s]:!a.selectedCalendars[s]}}))},h=async s=>{s.preventDefault();const a=Object.entries(n.selectedCalendars).filter(([v,I])=>I).map(([v])=>v);if(a.length===0){alert("Please select at least one calendar");return}const r={summary:n.summary,description:n.description,start:{dateTime:new Date(n.start).toISOString(),timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone},end:{dateTime:new Date(n.end).toISOString(),timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone}};await c(r,a),f({summary:"",description:"",start:"",end:"",selectedCalendars:{}}),j()};return e.jsxs(M,{visible:u,onClose:j,children:[e.jsx($,{children:e.jsx(L,{children:"Create New Event"})}),e.jsx(R,{children:e.jsxs(te,{onSubmit:h,children:[e.jsx(w,{className:"mb-3",children:e.jsx(g,{children:e.jsx(D,{type:"text",name:"summary",label:"Event Title",value:n.summary,onChange:d,required:!0})})}),e.jsx(w,{className:"mb-3",children:e.jsx(g,{children:e.jsx(se,{name:"description",label:"Description",value:n.description,onChange:d,rows:3})})}),e.jsxs(w,{className:"mb-3",children:[e.jsx(g,{md:6,children:e.jsx(D,{type:"datetime-local",name:"start",label:"Start Date & Time",value:n.start,onChange:d,required:!0})}),e.jsx(g,{md:6,children:e.jsx(D,{type:"datetime-local",name:"end",label:"End Date & Time",value:n.end,onChange:d,required:!0})})]}),e.jsx(w,{className:"mb-3",children:e.jsxs(g,{children:[e.jsx("div",{className:"mb-2",children:"Select Calendars:"}),Object.entries(C).map(([s,a])=>e.jsx(W,{id:`calendar-${a}`,label:s,checked:n.selectedCalendars[a]||!1,onChange:()=>y(a)},a))]})})]})}),e.jsxs(A,{children:[e.jsx(p,{color:"secondary",onClick:j,children:"Cancel"}),e.jsx(p,{color:"primary",onClick:h,children:"Create Event"})]})]})},G={IPTIC:"c97b1ce91482334df9e9dc7e26a88e2694517c61f59b18c8734c39eab1807a23@group.calendar.google.com",Widu:"11ed05ca8bd2a6897944129fea7301f8de84e866411114fd6ec81d286218881b@group.calendar.google.com","WGG 2":"f6db8bc3d9c65d7ac01eb698fa9cb1ac2e6d650c49ee7dfae9df92468af367a9@group.calendar.google.com"},ne=()=>{const[u,j]=o.useState([]),[c,C]=o.useState(""),[n,f]=o.useState([]),[d,y]=o.useState(()=>{const t={};return Object.keys(G).forEach(i=>{t[i]=!0}),t}),h=o.useRef(null);X();const s=O.useSession(),a=O.useSupabaseClient(),[r,v]=o.useState(null),[I,T]=o.useState(!1),[Z,B]=o.useState(!1);o.useEffect(()=>{console.log("Initial selectedProjects:",d)},[]),o.useEffect(()=>{s!=null&&s.provider_token&&_()},[d,s]),o.useEffect(()=>{var t;console.log("Session state:",{exists:!!s,providerToken:!!(s!=null&&s.provider_token),user:(t=s==null?void 0:s.user)==null?void 0:t.email})},[s]),o.useEffect(()=>{console.log("Current search term:",c);const t=u.filter(i=>i.title.toLowerCase().includes(c.toLowerCase()));console.log("Filtered events:",t),f(t)},[c,u]);const _=async()=>{var t,i;try{const{data:{session:l},error:E}=await a.auth.getSession();if(E)throw E;const b=l==null?void 0:l.provider_token;if(!b)throw new Error("No access token found. Please sign in again.");console.log("Starting calendar fetch with token:",b.substring(0,20)+"...");let S=[];for(const[x,k]of Object.entries(G))if(d[x]){const N=await fetch(`https://www.googleapis.com/calendar/v3/calendars/${k}/events`,{headers:{Authorization:`Bearer ${b}`,"Content-Type":"application/json"}});if(!N.ok){const P=await N.text();throw console.error(`Error response for ${x}:`,P),new Error(`Failed to fetch calendar for ${x}`)}const F=await N.json();if(console.log(`Received ${((t=F.items)==null?void 0:t.length)||0} events for ${x}`),((i=F.items)==null?void 0:i.length)>0){const P=F.items.map(m=>({id:m.id,title:m.summary,start:m.start.date||m.start.dateTime,end:m.end.date||m.end.dateTime,description:m.description,url:m.htmlLink,project:x,location:m.location,creator:m.creator,attendees:m.attendees,extendedProps:{project:x}}));S=[...S,...P]}}console.log("Total events found:",S.length),console.log("Loaded events:",S),j(S)}catch(l){console.error("Error loading calendars:",l)}},z=t=>{t.jsEvent.preventDefault(),v(t.event),T(!0)},H=t=>{C(t.target.value)},V=t=>{y(i=>({...i,[t]:!i[t]}))},q=async()=>{try{const{data:t,error:i}=await a.auth.signInWithOAuth({provider:"google",options:{scopes:["email","profile","https://www.googleapis.com/auth/calendar","https://www.googleapis.com/auth/calendar.events","https://www.googleapis.com/auth/calendar.readonly","https://www.googleapis.com/auth/calendar.events.readonly"].join(" "),redirectTo:`${window.location.origin}`}});if(i)throw i}catch(t){console.error("Error signing in with Google:",t.message)}},J=async()=>{try{const{error:t}=await a.auth.signOut();if(t)throw t}catch(t){console.error("Error signing out:",t.message)}},K=async(t,i)=>{try{const{data:{session:l},error:E}=await a.auth.getSession();if(E)throw E;const b=l==null?void 0:l.provider_token;if(!b)throw new Error("No access token found. Please sign in again.");const S=i.map(async x=>{const k=await fetch(`https://www.googleapis.com/calendar/v3/calendars/${x}/events`,{method:"POST",headers:{Authorization:`Bearer ${b}`,"Content-Type":"application/json"},body:JSON.stringify(t)});if(!k.ok){const N=await k.text();throw new Error(`Failed to create event: ${N}`)}return k.json()});await Promise.all(S),_()}catch(l){console.error("Error creating events:",l),alert("Failed to create events: "+l.message)}},Q=t=>{v(t),T(!0)};return e.jsxs("div",{className:"calendar-wrapper",children:[e.jsx(w,{children:e.jsx(g,{children:e.jsx("h1",{className:"redboost-title",children:"RedBoost Agenda"})})}),e.jsx(w,{className:"mb-4",children:e.jsx(g,{children:s?e.jsxs(e.Fragment,{children:[e.jsxs("h2",{className:"welcome-text",children:["Hello ",s.user.user_metadata.name]}),!s.provider_token&&e.jsxs("div",{className:"alert alert-warning",children:["Calendar access not authorized. Please sign in with Google again.",e.jsx(p,{onClick:q,color:"primary",className:"ms-3",children:"Sign In with Google"})]})]}):e.jsx(p,{onClick:q,color:"primary",children:"Sign In with Google"})})}),e.jsx(w,{children:e.jsx(g,{children:e.jsx("p",{className:"agenda-description",children:"This agenda displays events from Google Calendars for selected projects."})})}),e.jsxs(w,{className:"agenda-header mb-4",children:[e.jsx(g,{md:2,children:e.jsx(D,{type:"text",placeholder:"Search events...",value:c,onChange:H,className:"search-input"})}),e.jsx(g,{md:6,children:e.jsx("div",{className:"project-filters",children:Object.keys(G).map(t=>e.jsx(W,{inline:!0,id:t,label:t,checked:d[t]||!1,onChange:()=>V(t)},t))})}),e.jsxs(g,{md:4,className:"d-flex justify-content-end align-items-center",children:[e.jsx(p,{onClick:J,color:"danger",className:"float-end me-2",children:"Sign Out"}),e.jsx(p,{color:"primary",onClick:()=>B(!0),children:"+ Create Event"})]})]}),c&&n.length>0&&e.jsx(ae,{className:"mb-4",children:n.map(t=>e.jsxs(re,{onClick:()=>Q(t),className:"search-result-item",style:{cursor:"pointer"},children:[t.title," - ",new Date(t.start).toLocaleString()]},t.id))}),e.jsx("div",{className:"calendar-container",children:e.jsx(U,{ref:h,plugins:[ee],initialView:"dayGridMonth",events:u,eventClick:z,height:"auto",contentHeight:"auto",eventInteractive:!0,navLinks:!1})}),e.jsxs(M,{visible:I,onClose:()=>T(!1),children:[e.jsx($,{children:e.jsx(L,{children:r==null?void 0:r.title})}),e.jsx(R,{children:r&&e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Project:"})," ",r.extendedProps.project]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Start:"})," ",new Date(r.start).toLocaleString()]}),e.jsxs("p",{children:[e.jsx("strong",{children:"End:"})," ",new Date(r.end).toLocaleString()]}),r.description&&e.jsxs("p",{children:[e.jsx("strong",{children:"Description:"})," ",r.description]})]})}),e.jsxs(A,{children:[e.jsx(p,{color:"secondary",onClick:()=>T(!1),children:"Close"}),r&&e.jsx(p,{color:"primary",onClick:()=>window.open(r.url,"_blank"),disabled:!r.url,children:"View in Google Calendar"})]})]}),e.jsx(oe,{visible:Z,onClose:()=>B(!1),onCreateEvent:K,projectCalendars:G})]})};function ve(){const u=O.useSupabaseClient(),j=Y(h=>h.user),[c,C]=o.useState(!1),[n,f]=o.useState(!1);o.useEffect(()=>{(async()=>{const{data:{session:a},error:r}=await u.auth.getSession();r?(console.error("Error fetching session:",r.message),C(!1)):C(!!a)})();const{data:s}=u.auth.onAuthStateChange((a,r)=>{C(!!r)});return()=>{s!=null&&s.subscription&&s.subscription.unsubscribe()}},[u]);const d=async()=>{try{const{data:h,error:s}=await u.auth.signInWithOAuth({provider:"google",options:{scopes:["email","profile","https://www.googleapis.com/auth/calendar","https://www.googleapis.com/auth/calendar.events"].join(" "),redirectTo:`${window.location.origin}`}});if(s)throw s;console.log("Google sign-in data:",h)}catch(h){console.error("Error signing in with Google:",h.message)}};o.useEffect(()=>{f(!c)},[c]);const y=(j==null?void 0:j.isAuthenticated)||c;return e.jsx(e.Fragment,{children:y?e.jsx(ne,{}):e.jsxs(M,{visible:n,onClose:()=>f(!1),children:[e.jsx($,{children:e.jsx(L,{children:"Login Required"})}),e.jsx(R,{children:"Please connect to Gmail to view your RedBoost Agenda."}),e.jsxs(A,{children:[e.jsx(p,{color:"primary",onClick:d,children:"Login with Gmail"}),e.jsx(p,{color:"secondary",onClick:()=>f(!1),children:"Close"})]})]})})}export{ve as default};
